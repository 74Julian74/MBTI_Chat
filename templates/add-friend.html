<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>好友系统</title>
    <meta name="csrf-token" content="{{ csrf_token() }}">
    <style>
        body {
            font-family: 'Microsoft YaHei', '微软雅黑', sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            height: 100vh;
        }
        .left-panel, .right-panel {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }
        .left-panel {
            background-color: #f0f0f0;
            border-right: 1px solid #ccc;
        }
        .right-panel {
            background-color: #e0e0e0;
        }
        h2 {
            margin-top: 0;
        }
        input, button {
            margin: 5px 0;
            padding: 5px;
        }
        #searchResults, #friendRequests {
            margin-top: 20px;
        }
        .user-card {
            background-color: white;
            border: 1px solid #ddd;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 5px;
        }
        .user-card img {
            width: 50px;
            height: 50px;
            border-radius: 25px;
            margin-right: 10px;
            vertical-align: middle;
        }
    </style>
</head>
<body>
    <div class="left-panel">
        <h2>搜索好友</h2>
        <input type="text" id="searchId" placeholder="输入用户ID">
        <input type="text" id="searchUsername" placeholder="输入用户名">
        <button onclick="searchFriend()">搜索</button>
        <div id="searchResults"></div>
    </div>
    <div class="right-panel">
        <h2>好友请求</h2>
        <div id="friendRequests"></div>
    </div>

    <script>
    function getCsrfToken() {
        return document.querySelector('meta[name="csrf-token"]').getAttribute('content');
    }

    function searchFriend() {
        const id = document.getElementById('searchId').value.trim();
        const username = document.getElementById('searchUsername').value.trim();

        if (!id || !username) {
            alert('请同时输入ID和用户名');
            return;
        }

        console.log(`正在搜索好友 - ID: ${id}, 用户名: ${username}`);

        fetch('/search_friend', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': getCsrfToken()
            },
            body: `search_id=${encodeURIComponent(id)}&search_username=${encodeURIComponent(username)}`
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('搜索结果:', data);
            const resultsDiv = document.getElementById('searchResults');
            resultsDiv.innerHTML = '';
            if (Array.isArray(data) && data.length > 0) {
                data.forEach(user => {
                    const userCard = document.createElement('div');
                    userCard.className = 'user-card';
                    userCard.innerHTML = `
                        <img src="/uploads/${user.profile_picture}" alt="头像" onerror="this.src='/static/default_avatar.png'">
                        <span>ID: ${user.id}</span>
                        <span>用户名: ${user.username}</span>
                        <button onclick="sendFriendRequest(${user.id})">发送好友请求</button>
                    `;
                    resultsDiv.appendChild(userCard);
                });
            } else {
                resultsDiv.innerHTML = '<p>未找到用户</p>';
            }
        })
        .catch(error => {
            console.error('搜索出错:', error);
            alert('搜索时出错: ' + error.message);
        });
    }

    function sendFriendRequest(friendId) {
        fetch('/send_friend_request', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': getCsrfToken()
            },
            body: `friend_id=${friendId}`
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                alert('好友请求已发送');
            } else {
                alert(data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('发送好友请求时出错');
        });
    }

    function getFriendRequests() {
        fetch('/get_friend_requests')
        .then(response => response.json())
        .then(data => {
            const requestsDiv = document.getElementById('friendRequests');
            requestsDiv.innerHTML = '';
            if (Array.isArray(data) && data.length > 0) {
                data.forEach(request => {
                    const requestCard = document.createElement('div');
                    requestCard.className = 'user-card';
                    requestCard.innerHTML = `
                        <img src="/uploads/${request.profile_picture}" alt="头像" onerror="this.src='/static/default_avatar.png'">
                        <span>ID: ${request.id}</span>
                        <span>用户名: ${request.username}</span>
                        <button onclick="respondToFriendRequest(${request.id}, 'accepted')">接受</button>
                        <button onclick="respondToFriendRequest(${request.id}, 'rejected')">拒绝</button>
                    `;
                    requestsDiv.appendChild(requestCard);
                });
            } else {
                requestsDiv.innerHTML = '<p>暂无好友请求</p>';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('获取好友请求时出错');
        });
    }

    function respondToFriendRequest(friendId, response) {
        fetch('/respond_friend_request', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            },
            body: JSON.stringify({ friend_id: friendId, response: response })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                alert('好友请求已处理');
                getFriendRequests(); // 刷新好友请求列表
            } else {
                alert(data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('处理好友请求时出错');
        });
    }

    // 页面加载时获取好友请求
    window.onload = getFriendRequests;
    </script>
</body>
</html>