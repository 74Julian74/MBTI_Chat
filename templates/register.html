{% extends "bootstrap4/base.html" %}
{% block title %}註冊{% endblock %}
{% block styles %}
    {{super()}}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/register.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/verify-email.css') }}">
{% endblock %}
{% block content %}
<div class="BG-group">
    <img
      class="BG-icon1"
      loading="lazy"
      alt=""
      src="{{ url_for('static', filename='image/627e355dc75c2e90373cb295-hero20visualp1600png@2x.png') }}"
    />
    <div class="register-container">
        <h1>註冊</h1>
        <div class="register-form">
            <h2>Sign up</h2>
            <form method="POST" action="{{ url_for('auth.register') }}" id="register-form">
                <div class="form-group">
                    {{ form.email.label(class="form-label") }}
                    {{ form.email(class="form-input", placeholder="Email", autocomplete="email") }}
                </div>
                <div class="form-group">
                    {{ form.password.label(class="form-label") }}
                    {{ form.password(class="form-input", placeholder="密碼", autocomplete="new-password") }}
                </div>
                <div class="form-group">
                    {{ form.password2.label(class="form-label") }}
                    {{ form.password2(class="form-input", placeholder="確認密碼", autocomplete="new-password") }}
                </div>
                {{ form.submit(class="submit-button") }}
            </form>
        </div>
    </div>
</div>

<!-- 彈出窗口 -->
<div id="verification-modal" class="modal" style="display: none;">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h1>驗證您的電子郵件</h1>
        <form id="verification-form" method="post" action="{{ url_for('auth.verify_email') }}">
            <label for="verification_code">請輸入您收到的驗證碼:</label>
            <input type="text" id="verification_code" name="verification_code" required>
            <button type="submit">送出</button>
        </form>
    </div>
</div>

{% endblock %}
{% block scripts %}
{{super()}}
<script src="{{ url_for('static', filename='js/socket.io.min.js') }}"></script>
<script>
  document.addEventListener("DOMContentLoaded", function() {
    let form = document.getElementById("register-form");
    let modal = document.getElementById("verification-modal");
    let closeBtn = document.getElementsByClassName("close")[0];

    // 當表單提交時，顯示模態窗口
    form.addEventListener("submit", function(event) {
        event.preventDefault();

        const formData = new FormData(form);

        fetch(form.action, {
            method: 'POST',
            body: formData,
        }).then(response => response.json())
        .then(data => {
            if (data.status === "success") {
                modal.style.display = "block";
            } else {
                alert(data.message); // 顯示錯誤信息
            }
        })
        .catch(error => console.error('Error:', error));
    });

    // 當用户點擊關閉按鈕時，關閉模態窗口
    closeBtn.onclick = function() {
        modal.style.display = "none";
    };

    // 當用户點擊窗口外部時，關閉模態窗口
    window.onclick = function(event) {
        if (event.target === modal) {
            modal.style.display = "none";
        }
    };

    // 設置 Socket.io 連接
    const socket = io();

    // 當用户提交驗證碼表單時
    document.getElementById('verification-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const verificationInput = document.getElementById('verification_code');
        const verificationCode = verificationInput.value;
        if (verificationCode.trim()) {
            socket.emit('verify_email', { code: verificationCode });
        }
    });

    // 接收驗證結果
    socket.on('verification_result', function(data) {
        if (data.success) {
            alert("驗證成功！");
            modal.style.display = "none"; // 隱藏模態窗口
        } else {
            alert("驗證碼錯誤，請重試！");
        }
    });
});

</script>
{% endblock %}
